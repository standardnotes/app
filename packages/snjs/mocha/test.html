<html>

<head>
  <meta charset="utf-8">
  <title>Mocha Tests</title>
  <link href="assets/mocha.css" rel="stylesheet" />
  <script src="https://unpkg.com/chai@4.3.6/chai.js"></script>
  <script src="./vendor/chai-as-promised-built.js"></script>
  <script src="https://unpkg.com/regenerator-runtime@0.13.9/runtime.js"></script>
  <script src="https://unpkg.com/mocha@9.2.2/mocha.js"></script>
  <script src="https://unpkg.com/chai-subset@1.6.0/lib/chai-subset.js"></script>
  <script src="https://unpkg.com/sinon@13.0.2/pkg/sinon.js"></script>
  <script src="./vendor/sncrypto-web.js"></script>
  <script src="../dist/snjs.js"></script>

  <script type="module">
    Object.assign(window, SNCrypto);
    Object.assign(window, SNLibrary);

    import MainRegistry from './TestRegistry/MainRegistry.js'

    const InternalFeatureStatus = {
      [InternalFeature.Vaults]: { enabled: false, exclusive: false },
    }

    SNLog.onLog = (message) => {
      console.log(message);
    };

    SNLog.onError = (error) => {
      console.error(error);
    };

    const loadTest = (fileName) => {
      const script = document.createElement('script');
      script.type = 'module';
      script.src = fileName;
      document.head.appendChild(script);
    }

    const loadTests = (fileNames) => {
      fileNames.map(loadTest);
    }

    if (InternalFeatureStatus[InternalFeature.Vaults].enabled) {
      InternalFeatureService.get().enableFeature(InternalFeature.Vaults);
      loadTests(MainRegistry.VaultTests);
    }

    if (!InternalFeatureStatus[InternalFeature.Vaults].exclusive) {
      loadTests(MainRegistry.BaseTests);
    }

    setTimeout(() => {
      mocha.run()
    }, 250);


    const urlParams = new URLSearchParams(window.location.search);
    const bail = urlParams.get('bail') === 'false' ? false : true;
    const skipPaidFeatures = urlParams.get('skip_paid_features') === 'true' ? true : false;

    mocha.setup({
      ui: 'bdd',
      timeout: 5000,
      bail: bail,
    });
    if (skipPaidFeatures) {
      mocha.grep('@paidfeature').invert();
    }
  </script>
</head>

<body>
  <div id="mocha"></div>
</body>

</html>