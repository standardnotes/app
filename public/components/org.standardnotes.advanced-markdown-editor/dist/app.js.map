{"version":3,"sources":["app.js"],"names":["document","addEventListener","event","workingNote","componentManager","ComponentManager","body","classList","add","platform","environment","ignoreTextChange","initialLoad","lastValue","lastUUID","clientData","streamContextItem","note","uuid","isMetadataUpdate","window","easymde","content","text","value","codemirror","getDoc","clearHistory","mode","isPreviewActive","togglePreview","isSideBySideActive","toggleSideBySide","EasyMDE","element","getElementById","autoDownloadFontAwesome","spellChecker","status","shortcuts","toolbar","className","default","name","noDisable","title","action","saveMetadata","noMobile","getEditorMode","editor","saveItemWithPresave","toggleFullScreen","e","setOption","on","strip","html","tmp","implementation","createHTMLDocument","innerHTML","textContent","innerText","truncateString","string","limit","length","substring","options","previewRender","strippedHtml","preview_plain","preview_html"],"mappings":"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","file":"app.js","sourcesContent":["document.addEventListener(\"DOMContentLoaded\", function(event) {\n\n  var workingNote;\n\n  var componentManager = new ComponentManager(null, () => {\n    // on ready\n    document.body.classList.add(componentManager.platform);\n    document.body.classList.add(componentManager.environment);\n  });\n\n  var ignoreTextChange = false;\n  var initialLoad = true;\n  var lastValue, lastUUID, clientData;\n\n  componentManager.streamContextItem((note) => {\n\n    if(note.uuid !== lastUUID) {\n      // Note changed, reset last values\n      lastValue = null;\n      initialLoad = true;\n      lastUUID = note.uuid;\n      clientData = note.clientData;\n    }\n\n    workingNote = note;\n\n     // Only update UI on non-metadata updates.\n    if(note.isMetadataUpdate || !window.easymde) {\n      return;\n    }\n\n    if(note.content.text !== lastValue) {\n      ignoreTextChange = true;\n      window.easymde.value(note.content.text);\n      ignoreTextChange = false;\n    }\n\n    if(initialLoad) {\n      initialLoad = false;\n      window.easymde.codemirror.getDoc().clearHistory();\n      var mode = clientData && clientData.mode;\n\n      // Set initial editor mode\n      if(mode === 'preview') {\n        if(!window.easymde.isPreviewActive()) {\n          window.easymde.togglePreview();\n        }\n      } else if(mode === 'split') {\n        if(!window.easymde.isSideBySideActive()) {\n          window.easymde.toggleSideBySide();\n        }\n      // falback config\n      } else if(window.easymde.isPreviewActive()) {\n        window.easymde.togglePreview();\n      }\n    }\n  });\n\n  window.easymde = new EasyMDE({\n    element: document.getElementById(\"editor\"),\n    autoDownloadFontAwesome: false,\n    spellChecker: false,\n    status: false,\n    shortcuts: {\n      toggleSideBySide: \"Cmd-Alt-P\"\n    },\n    // Syntax highlighting is disabled until we figure out performance issue: https://github.com/sn-extensions/advanced-markdown-editor/pull/20#issuecomment-513811633\n    // renderingConfig: {\n    //   codeSyntaxHighlighting: true\n    // },\n    toolbar:[\n      {\n        className: \"fa fa-eye\",\n        default: true,\n        name: \"preview\",\n        noDisable: true,\n        title: \"Toggle Preview\",\n        action: function() {\n          window.easymde.togglePreview();\n          saveMetadata();\n        }\n      },\n      {\n        className: \"fa fa-columns\",\n        default: true,\n        name: \"side-by-side\",\n        noDisable: true,\n        noMobile: true,\n        title: \"Toggle Side by Side\",\n        action: function() {\n          window.easymde.toggleSideBySide();\n          saveMetadata();\n        }\n      },\n      \"|\",\n      \"heading\", \"bold\", \"italic\", \"strikethrough\",\n      \"|\", \"quote\", \"code\",\n      \"|\", \"unordered-list\", \"ordered-list\",\n      \"|\", \"clean-block\",\n      \"|\", \"link\", \"image\",\n      \"|\", \"table\"\n    ]\n  });\n\n  function saveMetadata() {\n    function getEditorMode() {\n      var editor = window.easymde;\n\n      if(editor) {\n        if (editor.isPreviewActive()) return 'preview';\n        if (editor.isSideBySideActive()) return 'split';\n      }\n      return 'edit';\n    }\n\n    var note = workingNote;\n\n    componentManager.saveItemWithPresave(note, () => {\n      note.clientData = { mode: getEditorMode() };\n    });\n  }\n\n   // Some sort of issue on Mobile RN where this causes an exception (\".className is not defined\")\n   try {\n     window.easymde.toggleFullScreen();\n   } catch (e) {}\n\n   /*\n    Can be set to Infinity to make sure the whole document is always rendered, and thus the browser's text search works on it. This will have bad effects on performance of big documents.\n    Really bad performance on Safari. Unusable.\n    */\n  window.easymde.codemirror.setOption(\"viewportMargin\", 100);\n\n  window.easymde.codemirror.on(\"change\", function() {\n\n    function strip(html) {\n      var tmp = document.implementation.createHTMLDocument(\"New\").body;\n      tmp.innerHTML = html;\n      return tmp.textContent || tmp.innerText || \"\";\n    }\n\n    function truncateString(string, limit = 90) {\n      if(string.length <= limit) {\n        return string;\n      } else {\n        return string.substring(0, limit) + \"...\";\n      }\n    }\n\n    if(!ignoreTextChange) {\n      if(workingNote) {\n        // Be sure to capture this object as a variable, as this.note may be reassigned in `streamContextItem`, so by the time\n        // you modify it in the presave block, it may not be the same object anymore, so the presave values will not be applied to\n        // the right object, and it will save incorrectly.\n        let note = workingNote;\n\n        componentManager.saveItemWithPresave(note, () => {\n          lastValue = window.easymde.value();\n\n          var html = window.easymde.options.previewRender(window.easymde.value());\n          var strippedHtml = truncateString(strip(html));\n\n          note.content.preview_plain = strippedHtml;\n          note.content.preview_html = null;\n          note.content.text = lastValue;\n        });\n\n      }\n    }\n  });\n});\n"]}